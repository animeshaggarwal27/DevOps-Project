pipeline {
  agent any
  environment {
    APP_DIR = '/srv/flask-app'
    VENV = "${APP_DIR}/.venv"
  }
  stages {
    stage('Checkout') {
      steps { checkout scm }
    }
    stage('Install deps') {
      steps {
        sh '''
          set -e
          sudo mkdir -p ${APP_DIR}
          sudo chown -R jenkins:jenkins ${APP_DIR}
          rsync -a --delete ./ ${APP_DIR}/
          python3 -m venv ${VENV} || true
          . ${VENV}/bin/activate
          pip install -U pip gunicorn
          if [ -f ${APP_DIR}/requirements.txt ]; then pip install -r ${APP_DIR}/requirements.txt; fi
        '''
      }
    }
    stage('Restart service') {
      steps {
        sh 'sudo systemctl restart flask'
      }
    }
  }
  post {
    success { echo 'Flask deployed ✅' }
    failure { echo 'Flask deploy failed ❌' }
  }
}
